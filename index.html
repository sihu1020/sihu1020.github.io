<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>나만의 라이프 비서</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1120;
        --bg-soft: rgba(15, 23, 42, 0.72);
        --surface: rgba(30, 41, 59, 0.78);
        --surface-solid: #1e293b;
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --accent-soft: rgba(56, 189, 248, 0.15);
        --text: #f8fafc;
        --muted: #94a3b8;
        --border: rgba(148, 163, 184, 0.28);
        --shadow: 0 20px 45px rgba(8, 47, 73, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.25), transparent 45%),
          radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.25), transparent 55%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 3.5rem;
        display: grid;
        gap: 1.75rem;
      }

      header {
        display: grid;
        gap: 1.5rem;
        padding: 1.75rem;
        border-radius: 28px;
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.22), rgba(56, 189, 248, 0.08));
        border: 1px solid rgba(125, 211, 252, 0.25);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      header::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 20% 30%, rgba(14, 165, 233, 0.4), transparent 55%);
        opacity: 0.6;
        pointer-events: none;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .welcome {
        display: grid;
        gap: 0.45rem;
      }

      .welcome h1 {
        margin: 0;
        font-size: clamp(1.95rem, 3vw, 2.4rem);
        font-weight: 700;
      }

      .welcome p {
        margin: 0;
        color: rgba(226, 232, 240, 0.82);
        font-weight: 500;
        letter-spacing: 0.01em;
      }

      .clock {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.75rem 1.1rem;
        background: rgba(15, 23, 42, 0.65);
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        backdrop-filter: blur(8px);
      }

      .clock strong {
        font-size: 1.4rem;
        letter-spacing: 0.08em;
      }

      .daily-focus {
        position: relative;
        z-index: 1;
        display: grid;
        gap: 1rem;
        padding: 1.2rem;
        border-radius: 20px;
        background: rgba(15, 23, 42, 0.65);
        border: 1px solid rgba(226, 232, 240, 0.08);
        backdrop-filter: blur(10px);
      }

      .daily-focus h2 {
        margin: 0;
        font-size: 1.2rem;
      }

      .focus-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .focus-card {
        padding: 1rem 1.2rem;
        border-radius: 18px;
        background: rgba(56, 189, 248, 0.12);
        border: 1px solid rgba(125, 211, 252, 0.32);
        display: grid;
        gap: 0.35rem;
      }

      .focus-card span {
        font-size: 0.85rem;
        color: rgba(148, 163, 184, 0.9);
      }

      .focus-card strong {
        font-size: 1.05rem;
      }

      section {
        display: grid;
        gap: 1.2rem;
      }

      .grid-layout {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .panel {
        background: var(--surface);
        border-radius: 22px;
        border: 1px solid var(--border);
        padding: 1.4rem;
        display: grid;
        gap: 1rem;
        min-height: 0;
        box-shadow: 0 14px 35px rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(8px);
      }

      .panel h2 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .panel h2 span {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--muted);
      }

      form {
        display: grid;
        gap: 0.75rem;
      }

      label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.85rem;
        color: rgba(148, 163, 184, 0.95);
      }

      input,
      select,
      textarea {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.55);
        color: var(--text);
        padding: 0.65rem 0.85rem;
        font-size: 0.95rem;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }

      textarea {
        resize: vertical;
        min-height: 120px;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(56, 189, 248, 0.7);
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.18);
      }

      button {
        border: none;
        border-radius: 14px;
        padding: 0.6rem 1.1rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.2s ease, background 0.2s ease;
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.85), rgba(14, 165, 233, 0.85));
        color: #0f172a;
        box-shadow: 0 12px 28px rgba(14, 165, 233, 0.35);
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(14, 165, 233, 0.4);
      }

      button.secondary {
        background: rgba(148, 163, 184, 0.18);
        color: rgba(226, 232, 240, 0.92);
        box-shadow: none;
      }

      .timeline {
        display: grid;
        gap: 0.75rem;
        max-height: 380px;
        overflow-y: auto;
      }

      .timeline-item {
        display: grid;
        gap: 0.35rem;
        padding: 0.85rem 1rem;
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .timeline-item strong {
        font-size: 1.05rem;
      }

      .timeline-item footer {
        display: flex;
        gap: 0.75rem;
        font-size: 0.82rem;
        color: var(--muted);
        flex-wrap: wrap;
      }

      .tag {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.15);
        color: rgba(125, 211, 252, 0.95);
        font-size: 0.75rem;
      }

      .task-controls {
        display: flex;
        gap: 0.6rem;
        flex-wrap: wrap;
      }

      .task-controls button {
        background: rgba(15, 23, 42, 0.6);
        color: rgba(226, 232, 240, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: none;
      }

      .task-controls button.active {
        background: rgba(56, 189, 248, 0.25);
        border-color: rgba(56, 189, 248, 0.4);
        color: rgba(125, 211, 252, 0.95);
      }

      .task-list {
        display: grid;
        gap: 0.75rem;
        max-height: 320px;
        overflow-y: auto;
      }

      .task-item {
        display: grid;
        gap: 0.4rem;
        padding: 0.85rem 1rem;
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.22);
        position: relative;
      }

      .task-item.completed {
        opacity: 0.6;
      }

      .task-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }

      .task-title {
        font-size: 1.02rem;
        font-weight: 600;
      }

      .task-meta {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        font-size: 0.8rem;
        color: var(--muted);
        align-items: center;
      }

      .task-actions {
        display: flex;
        gap: 0.4rem;
      }

      .task-actions button {
        font-size: 0.8rem;
        padding: 0.4rem 0.7rem;
      }

      .empty-state {
        padding: 1.2rem;
        text-align: center;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.45);
        border: 1px dashed rgba(148, 163, 184, 0.3);
        color: var(--muted);
      }

      .notes textarea {
        min-height: 200px;
      }

      .habit-grid {
        display: grid;
        gap: 0.8rem;
      }

      .habit-row {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: minmax(140px, 1fr) repeat(7, minmax(36px, 1fr));
        align-items: center;
        padding: 0.9rem 1rem;
        border-radius: 16px;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      .habit-name {
        font-weight: 600;
      }

      .habit-day {
        display: grid;
        place-items: center;
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(148, 163, 184, 0.25);
        cursor: pointer;
        transition: background 0.18s ease, border 0.18s ease, transform 0.18s ease;
        font-size: 0.78rem;
      }

      .habit-day.active {
        background: rgba(56, 189, 248, 0.35);
        border-color: rgba(56, 189, 248, 0.5);
        color: rgba(15, 23, 42, 0.95);
        font-weight: 600;
      }

      .summary-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .summary-card {
        padding: 1.1rem 1.3rem;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.58);
        border: 1px solid rgba(148, 163, 184, 0.2);
        display: grid;
        gap: 0.45rem;
      }

      .summary-card span {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .summary-card strong {
        font-size: 1.35rem;
      }

      @media (max-width: 768px) {
        .habit-row {
          grid-template-columns: 1fr 1fr 1fr 1fr;
          row-gap: 0.6rem;
        }

        .habit-row .habit-name {
          grid-column: 1 / -1;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div class="header-top">
          <div class="welcome">
            <h1 id="greeting">좋은 하루예요!</h1>
            <p>오늘 해야 할 일과 일정을 제가 한눈에 정리해 드릴게요.</p>
          </div>
          <div class="clock">
            <div>
              <span>오늘은</span>
              <div id="current-date"></div>
            </div>
            <strong id="current-time">00:00</strong>
          </div>
        </div>
        <div class="daily-focus">
          <h2>오늘의 포커스</h2>
          <div class="focus-grid">
            <div class="focus-card">
              <span>가장 중요한 일정</span>
              <strong id="focus-event">등록된 일정이 없습니다.</strong>
            </div>
            <div class="focus-card">
              <span>최우선 할 일</span>
              <strong id="focus-task">할 일을 추가해 보세요.</strong>
            </div>
            <div class="focus-card">
              <span>오늘의 목표</span>
              <strong id="focus-message">하루에 한 가지씩 성취해봐요.</strong>
            </div>
          </div>
        </div>
      </header>

      <section class="summary">
        <div class="summary-grid">
          <div class="summary-card">
            <span>진행 중인 일정</span>
            <strong id="summary-events">0개</strong>
            <small id="next-event">다음 일정이 없습니다.</small>
          </div>
          <div class="summary-card">
            <span>해야 할 일</span>
            <strong id="summary-tasks">0개</strong>
            <small id="next-task">마감 기한이 없습니다.</small>
          </div>
          <div class="summary-card">
            <span>완료한 습관</span>
            <strong id="summary-habits">0회</strong>
            <small>이번 주 꾸준함을 이어가요.</small>
          </div>
        </div>
      </section>

      <section class="grid-layout">
        <div class="panel">
          <h2>
            일정 타임라인
            <span>오늘의 계획을 시간 순으로 정리해 드려요.</span>
          </h2>
          <form id="event-form">
            <label>
              일정 이름
              <input type="text" id="event-title" placeholder="예: 팀 미팅" required />
            </label>
            <div class="grid-layout" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
              <label>
                시간
                <input type="time" id="event-time" required />
              </label>
              <label>
                위치 / 방식
                <input type="text" id="event-location" placeholder="예: 회의실 A / 온라인" />
              </label>
            </div>
            <button type="submit">일정 추가</button>
          </form>
          <div class="timeline" id="timeline"></div>
        </div>

        <div class="panel">
          <h2>
            할 일 관리
            <span>중요도와 마감일을 기준으로 스마트하게 정리해요.</span>
          </h2>
          <form id="task-form">
            <label>
              할 일 제목
              <input type="text" id="task-title" placeholder="예: 보고서 검토" required />
            </label>
            <div class="grid-layout" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
              <label>
                마감일
                <input type="date" id="task-date" />
              </label>
              <label>
                우선순위
                <select id="task-priority">
                  <option value="높음">높음</option>
                  <option value="보통" selected>보통</option>
                  <option value="낮음">낮음</option>
                </select>
              </label>
              <label>
                카테고리
                <input type="text" id="task-category" placeholder="예: 업무, 개인" />
              </label>
            </div>
            <button type="submit">할 일 추가</button>
          </form>
          <div class="task-controls" id="task-filters"></div>
          <div class="task-list" id="task-list"></div>
        </div>
      </section>

      <section class="grid-layout">
        <div class="panel notes">
          <h2>
            빠른 메모
            <span>아이디어가 떠오르면 바로 기록해 두세요.</span>
          </h2>
          <textarea id="notes" placeholder="오늘의 회의 메모, 아이디어 등을 자유롭게 적어보세요."></textarea>
          <div class="task-controls">
            <button type="button" class="secondary" id="clear-notes">메모 비우기</button>
            <span style="font-size: 0.8rem; color: var(--muted);">자동 저장됩니다.</span>
          </div>
        </div>

        <div class="panel">
          <h2>
            주간 습관 체크
            <span>꾸준함을 기록하고 동기부여를 유지하세요.</span>
          </h2>
          <div class="habit-grid" id="habit-grid"></div>
        </div>
      </section>
    </main>

    <script>
      const storageKeys = {
        events: "assistant-events",
        tasks: "assistant-tasks",
        notes: "assistant-notes",
        habits: "assistant-habits"
      };

      const dom = {
        greeting: document.getElementById("greeting"),
        currentDate: document.getElementById("current-date"),
        currentTime: document.getElementById("current-time"),
        focusEvent: document.getElementById("focus-event"),
        focusTask: document.getElementById("focus-task"),
        focusMessage: document.getElementById("focus-message"),
        summaryEvents: document.getElementById("summary-events"),
        nextEvent: document.getElementById("next-event"),
        summaryTasks: document.getElementById("summary-tasks"),
        nextTask: document.getElementById("next-task"),
        summaryHabits: document.getElementById("summary-habits"),
        timeline: document.getElementById("timeline"),
        eventForm: document.getElementById("event-form"),
        eventTitle: document.getElementById("event-title"),
        eventTime: document.getElementById("event-time"),
        eventLocation: document.getElementById("event-location"),
        taskForm: document.getElementById("task-form"),
        taskTitle: document.getElementById("task-title"),
        taskDate: document.getElementById("task-date"),
        taskPriority: document.getElementById("task-priority"),
        taskCategory: document.getElementById("task-category"),
        taskFilters: document.getElementById("task-filters"),
        taskList: document.getElementById("task-list"),
        notes: document.getElementById("notes"),
        clearNotes: document.getElementById("clear-notes"),
        habitGrid: document.getElementById("habit-grid")
      };

      const defaultHabits = [
        { name: "아침 스트레칭", days: {} },
        { name: "집중 업무 2시간", days: {} },
        { name: "물 8컵 마시기", days: {} },
        { name: "영어 학습", days: {} }
      ];

      let events = load(storageKeys.events, []);
      let tasks = load(storageKeys.tasks, []);
      let habits = load(storageKeys.habits, defaultHabits);

      function cloneDefault(value) {
        if (typeof value === "string") return value;
        try {
          return JSON.parse(JSON.stringify(value));
        } catch (error) {
          console.error("기본값 복제 중 오류", error);
          return value;
        }
      }

      function load(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return cloneDefault(fallback);
          return JSON.parse(raw);
        } catch (err) {
          console.error("데이터를 불러오는 중 오류", err);
          return cloneDefault(fallback);
        }
      }

      function persist(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      }

      function formatDate(date) {
        return date.toLocaleDateString("ko-KR", {
          month: "long",
          day: "numeric",
          weekday: "short"
        });
      }

      function updateClock() {
        const now = new Date();
        dom.currentDate.textContent = formatDate(now);
        dom.currentTime.textContent = now.toLocaleTimeString("ko-KR", {
          hour: "2-digit",
          minute: "2-digit"
        });

        const hour = now.getHours();
        let greeting = "좋은 하루예요!";
        if (hour < 6) greeting = "새벽형 인간이시군요!";
        else if (hour < 12) greeting = "상쾌한 아침입니다.";
        else if (hour < 18) greeting = "에너지가 필요한 오후예요.";
        else greeting = "오늘 하루 마무리 잘 하고 계신가요?";
        dom.greeting.textContent = greeting;
      }

      updateClock();
      setInterval(updateClock, 30000);

      function minutesFromTime(time) {
        if (!time) return Number.POSITIVE_INFINITY;
        const [h, m] = time.split(":").map(Number);
        return h * 60 + m;
      }

      function renderTimeline() {
        if (!events.length) {
          dom.timeline.innerHTML = `<div class="empty-state">등록된 일정이 없습니다. 중요한 약속을 추가해 보세요.</div>`;
          return;
        }

        const sorted = [...events].sort(
          (a, b) => minutesFromTime(a.time) - minutesFromTime(b.time)
        );

        dom.timeline.innerHTML = sorted
          .map((event) => {
            const location = event.location ? `<span class="tag">${event.location}</span>` : "";
            const timeLabel = event.time ? event.time : "시간 미정";
            return `
              <div class="timeline-item" data-id="${event.id}">
                <strong>${event.title}</strong>
                <footer>
                  <span>${timeLabel}</span>
                  ${location}
                  <button class="secondary" data-action="remove-event" data-id="${event.id}">삭제</button>
                </footer>
              </div>
            `;
          })
          .join("");
      }

      function renderTaskFilters(active = "all") {
        const filters = [
          { key: "all", label: "전체" },
          { key: "active", label: "진행 중" },
          { key: "completed", label: "완료" }
        ];

        dom.taskFilters.innerHTML = filters
          .map(
            (filter) => `
            <button type="button" class="${filter.key === active ? "active" : ""}" data-filter="${filter.key}">
              ${filter.label}
            </button>
          `
          )
          .join("");
      }

      let currentFilter = "all";
      renderTaskFilters(currentFilter);

      dom.taskFilters.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-filter]");
        if (!button) return;
        currentFilter = button.dataset.filter;
        renderTaskFilters(currentFilter);
        renderTasks();
      });

      function renderTasks() {
        if (!tasks.length) {
          dom.taskList.innerHTML = `<div class="empty-state">할 일이 없습니다. 새 목표를 추가해 볼까요?</div>`;
          updateFocus();
          updateSummaries();
          return;
        }

        const filtered = tasks.filter((task) => {
          if (currentFilter === "completed") return task.completed;
          if (currentFilter === "active") return !task.completed;
          return true;
        });

        if (!filtered.length) {
          dom.taskList.innerHTML = `<div class="empty-state">선택한 조건에 해당하는 할 일이 없어요.</div>`;
          updateFocus();
          updateSummaries();
          return;
        }

        const sorted = [...filtered].sort((a, b) => {
          if (a.completed !== b.completed) return a.completed ? 1 : -1;
          if (a.priority !== b.priority) {
            const rank = { 높음: 0, 보통: 1, 낮음: 2 };
            return rank[a.priority] - rank[b.priority];
          }
          if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
          if (a.dueDate) return -1;
          if (b.dueDate) return 1;
          return a.title.localeCompare(b.title, "ko");
        });

        dom.taskList.innerHTML = sorted
          .map((task) => {
            const due = task.dueDate
              ? `<span>마감 ${new Date(task.dueDate + "T00:00").toLocaleDateString("ko-KR", {
                  month: "short",
                  day: "numeric",
                  weekday: "short"
                })}</span>`
              : "";
            const category = task.category
              ? `<span class="tag">${task.category}</span>`
              : "";
            return `
              <div class="task-item ${task.completed ? "completed" : ""}" data-id="${task.id}">
                <div class="task-top">
                  <div class="task-title">${task.title}</div>
                  <div class="task-actions">
                    <button class="secondary" data-action="toggle" data-id="${task.id}">
                      ${task.completed ? "되돌리기" : "완료"}
                    </button>
                    <button class="secondary" data-action="remove" data-id="${task.id}">삭제</button>
                  </div>
                </div>
                <div class="task-meta">
                  <span class="tag">우선순위 ${task.priority}</span>
                  ${category}
                  ${due}
                </div>
              </div>
            `;
          })
          .join("");

        updateFocus();
        updateSummaries();
      }

      function renderHabits() {
        const days = ["월", "화", "수", "목", "금", "토", "일"];
        dom.habitGrid.innerHTML = habits
          .map((habit, habitIndex) => {
            return `
              <div class="habit-row" data-index="${habitIndex}">
                <div class="habit-name">${habit.name}</div>
                ${days
                  .map((day, idx) => {
                    const active = habit.days[idx] ? "active" : "";
                    return `<div class="habit-day ${active}" data-day="${idx}">${day}</div>`;
                  })
                  .join("")}
              </div>
            `;
          })
          .join("");
      }

      function updateFocus() {
        if (!events.length) {
          dom.focusEvent.textContent = "등록된 일정이 없습니다.";
        } else {
          const next = [...events]
            .filter((event) => !!event.time)
            .sort((a, b) => minutesFromTime(a.time) - minutesFromTime(b.time))[0];
          if (next) {
            dom.focusEvent.textContent = `${next.time} · ${next.title}`;
          } else {
            dom.focusEvent.textContent = `${events[0].title}`;
          }
        }

        const nextTask = tasks
          .filter((task) => !task.completed)
          .sort((a, b) => {
            const rank = { 높음: 0, 보통: 1, 낮음: 2 };
            if (rank[a.priority] !== rank[b.priority]) {
              return rank[a.priority] - rank[b.priority];
            }
            if (a.dueDate && b.dueDate) return a.dueDate.localeCompare(b.dueDate);
            if (a.dueDate) return -1;
            if (b.dueDate) return 1;
            return a.title.localeCompare(b.title, "ko");
          })[0];

        dom.focusTask.textContent = nextTask ? `${nextTask.title}` : "할 일을 추가해 보세요.";

        if (tasks.length > 0 || events.length > 0) {
          dom.focusMessage.textContent = "중요한 일부터 차근차근 처리해요.";
        } else {
          dom.focusMessage.textContent = "하루에 한 가지씩 성취해봐요.";
        }
      }

      function updateSummaries() {
        dom.summaryEvents.textContent = `${events.length}개`;
        const sortedEvents = [...events].sort(
          (a, b) => minutesFromTime(a.time) - minutesFromTime(b.time)
        );
        if (sortedEvents.length) {
          const next = sortedEvents[0];
          const timeLabel = next.time ? `${next.time}` : "시간 미정";
          dom.nextEvent.textContent = `${timeLabel} · ${next.title}`;
        } else {
          dom.nextEvent.textContent = "다음 일정이 없습니다.";
        }

        dom.summaryTasks.textContent = `${tasks.filter((task) => !task.completed).length}개`;
        const upcomingTask = tasks
          .filter((task) => !task.completed && task.dueDate)
          .sort((a, b) => a.dueDate.localeCompare(b.dueDate))[0];
        dom.nextTask.textContent = upcomingTask
          ? `${new Date(upcomingTask.dueDate + "T00:00").toLocaleDateString("ko-KR", {
              month: "short",
              day: "numeric"
            })} · ${upcomingTask.title}`
          : "마감 기한이 없습니다.";

        const today = new Date().getDay();
        const total = habits.reduce((sum, habit) => sum + (habit.days[today] ? 1 : 0), 0);
        dom.summaryHabits.textContent = `${total}회`;
      }

      dom.eventForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const title = dom.eventTitle.value.trim();
        const time = dom.eventTime.value;
        const location = dom.eventLocation.value.trim();
        if (!title) return;
        events.push({
          id: crypto.randomUUID(),
          title,
          time,
          location
        });
        persist(storageKeys.events, events);
        dom.eventForm.reset();
        renderTimeline();
        updateFocus();
        updateSummaries();
      });

      dom.timeline.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action=remove-event]");
        if (!button) return;
        const id = button.dataset.id;
        events = events.filter((event) => event.id !== id);
        persist(storageKeys.events, events);
        renderTimeline();
        updateFocus();
        updateSummaries();
      });

      dom.taskForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const title = dom.taskTitle.value.trim();
        if (!title) return;
        tasks.push({
          id: crypto.randomUUID(),
          title,
          dueDate: dom.taskDate.value || null,
          priority: dom.taskPriority.value,
          category: dom.taskCategory.value.trim(),
          completed: false
        });
        persist(storageKeys.tasks, tasks);
        dom.taskForm.reset();
        renderTasks();
      });

      dom.taskList.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;
        const id = button.dataset.id;
        const action = button.dataset.action;
        if (action === "toggle") {
          tasks = tasks.map((task) =>
            task.id === id ? { ...task, completed: !task.completed } : task
          );
        } else if (action === "remove") {
          tasks = tasks.filter((task) => task.id !== id);
        }
        persist(storageKeys.tasks, tasks);
        renderTasks();
      });

      dom.notes.value = load(storageKeys.notes, "");
      dom.notes.addEventListener("input", () => {
        persist(storageKeys.notes, dom.notes.value);
      });

      dom.clearNotes.addEventListener("click", () => {
        if (!dom.notes.value) return;
        if (!confirm("메모를 모두 삭제할까요?")) return;
        dom.notes.value = "";
        persist(storageKeys.notes, "");
      });

      function ensureHabitStructure() {
        // 구조 변경 시 기본값 채우기
        habits = habits.map((habit) => ({
          name: habit.name,
          days: habit.days || {}
        }));
      }

      ensureHabitStructure();

      dom.habitGrid.addEventListener("click", (event) => {
        const cell = event.target.closest(".habit-day");
        if (!cell) return;
        const row = event.target.closest(".habit-row");
        const habitIndex = Number(row.dataset.index);
        const day = Number(cell.dataset.day);
        const habit = habits[habitIndex];
        const updated = !habit.days[day];
        habit.days[day] = updated;
        habits[habitIndex] = habit;
        persist(storageKeys.habits, habits);
        renderHabits();
        updateSummaries();
      });

      function initialize() {
        renderTimeline();
        renderTasks();
        renderHabits();
        updateFocus();
        updateSummaries();
      }

      initialize();
    </script>
  </body>
</html>
