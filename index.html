<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>동신과학고 뉴스룸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Gmarket+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1c89f4, #3fc0ff);
      --accent: #0f4c81;
      --accent-light: #d7ecff;
      --card-bg: #ffffff;
      --text: #1c1c1c;
      --muted: #5f7185;
      --shadow: 0 20px 40px rgba(17, 63, 119, 0.15);
      font-size: 16px;
    }

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>동신과학고 뉴스룸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Gmarket+Sans:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --gradient: linear-gradient(135deg, #1c89f4, #3fc0ff);
      --accent: #0f4c81;
      --accent-soft: #1f65a4;
      --surface: #ffffff;
      --muted: #5f7185;
      --shadow: 0 16px 36px rgba(15, 76, 129, 0.18);
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Gmarket Sans', 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
      background: #f5faff;
      color: #1c2432;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--gradient);
      color: #fff;
      padding: 1.5rem clamp(1.5rem, 4vw, 3rem);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 18px 36px rgba(15, 76, 129, 0.22);
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 4vw, 2.3rem);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
      font-size: 0.95rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 2.1rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.22);
      font-weight: 600;
      font-size: 0.85rem;
    }

    button {
      font: inherit;
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.4rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .login-btn {
      background: rgba(255, 255, 255, 0.22);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .login-btn:hover {
      background: rgba(255, 255, 255, 0.32);
    }

    main {
      flex: 1;
      padding: clamp(2.5rem, 5vw, 4rem) clamp(1.5rem, 6vw, 3.2rem) 5rem;
      max-width: 1180px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2.5rem;
    }

    .hero {
      background: var(--surface);
      border-radius: 24px;
      padding: clamp(2rem, 6vw, 3.4rem);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 2rem;
      align-items: center;
    }

    .hero h2 {
      margin: 0 0 1rem;
      color: var(--accent);
      font-size: clamp(2rem, 5vw, 2.8rem);
    }

    .hero p {
      margin: 0;
      color: var(--muted);
      line-height: 1.7;
    }

    .hero .pill {
      margin-bottom: 0.6rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      background: #e2f0ff;
      color: var(--accent);
      font-size: 0.9rem;
      font-weight: 600;
    }

    .news-section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .news-section-title h3 {
      margin: 0;
      color: var(--accent);
      font-size: clamp(1.8rem, 4vw, 2.4rem);
    }

    .news-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .news-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 1.7rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .news-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 48px rgba(15, 76, 129, 0.24);
    }

    .news-date {
      font-size: 0.92rem;
      color: var(--muted);
      letter-spacing: 0.04rem;
    }

    .news-title {
      margin: 0;
      font-size: 1.35rem;
      color: var(--accent);
    }

    .news-summary {
      margin: 0;
      font-weight: 600;
      color: var(--accent-soft);
    }

    .news-content {
      margin: 0;
      color: var(--muted);
      line-height: 1.7;
      white-space: pre-line;
    }

    .news-link {
      margin-top: 0.2rem;
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      gap: 0.3rem;
    }

    .news-link:hover {
      text-decoration: underline;
    }

    .panel {
      background: var(--surface);
      border-radius: 20px;
      padding: clamp(1.8rem, 5vw, 2.5rem);
      box-shadow: var(--shadow);
      display: grid;
      gap: 1.2rem;
    }

    .panel h3 {
      margin: 0;
      color: var(--accent);
      font-size: clamp(1.6rem, 4vw, 2rem);
    }

    form {
      display: grid;
      gap: 1rem;
    }

    label {
      font-weight: 600;
      color: var(--accent);
    }

    input,
    textarea {
      font: inherit;
      padding: 0.7rem 0.9rem;
      border-radius: 12px;
      border: 1px solid #d4e4f7;
      background: #f8fbff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(31, 120, 220, 0.15);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      align-items: end;
    }

    .form-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .submit-btn {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 12px 24px rgba(15, 76, 129, 0.32);
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      background: var(--accent-soft);
    }

    .secondary-btn {
      background: rgba(15, 76, 129, 0.12);
      color: var(--accent);
    }

    .secondary-btn:hover {
      background: rgba(15, 76, 129, 0.18);
    }

    .admin-controls {
      display: none;
    }

    .admin-controls.visible {
      display: grid;
    }

    .classroom-news {
      display: none;
    }

    .classroom-news.visible {
      display: grid;
    }

    .placeholder {
      margin: 0;
      color: var(--muted);
    }

    .error-text {
      color: #d84f4f;
      font-size: 0.95rem;
      display: none;
    }

    .error-text.visible {
      display: block;
    }

    .share-box {
      background: rgba(15, 76, 129, 0.08);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      display: grid;
      gap: 0.6rem;
    }

    .share-actions {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.75rem;
    }

    .share-help {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    footer {
      background: #0f2f4c;
      color: #cfe5ff;
      padding: 2.1rem clamp(1.5rem, 4vw, 3rem);
      text-align: center;
      font-size: 0.95rem;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 34, 58, 0.55);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
      z-index: 20;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 18px;
      padding: 2rem;
      max-width: 360px;
      width: 100%;
      display: grid;
      gap: 1.4rem;
      box-shadow: 0 24px 48px rgba(15, 76, 129, 0.35);
    }

    .modal-content h3 {
      margin: 0;
      color: var(--accent);
      text-align: center;
    }

    .modal-actions {
      display: grid;
      gap: 0.6rem;
    }

    .modal-close {
      background: none;
      color: var(--muted);
      justify-self: center;
      padding: 0;
    }

    @media (max-width: 640px) {
      .share-actions {
        grid-template-columns: 1fr;
      }

      .hero {
        text-align: center;
      }

      header {
        position: static;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>동신과학고 뉴스룸</h1>
    <div class="header-actions">
      <div id="login-status" class="status">
        <span class="badge">게스트</span>
        <span>읽기 전용 모드</span>
      </div>
      <button id="login-toggle" class="login-btn" type="button">관리자 로그인</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div>
        <span class="pill">학교 공식 뉴스</span>
        <h2>동신과학고의 하루를 한눈에</h2>
        <p>학교 행사와 교내 공지, 학생 자치 활동까지 빠르게 확인하세요. 관리자 인증 후 안전하게 내용을 수정할 수 있습니다.</p>
      </div>
      <div>
        <h3 style="margin: 0; color: var(--accent-soft); font-size: 1.2rem;">1학년 반별 뉴스룸 운영</h3>
        <p>1학년 1~5반 학생들은 부여된 3자리 고유 번호로 반별 소식을 확인하고, 관리자 모드에서 각 반의 기사를 관리할 수 있습니다.</p>
      </div>
    </section>

    <section>
      <div class="news-section-title">
        <h3>학교 주요 소식</h3>
        <span id="news-count" class="pill">총 0건의 업데이트</span>
      </div>
      <div id="news-list" class="news-list"></div>
    </section>

    <section class="panel">
      <h3>1학년 뉴스룸 입장</h3>
      <p>담임 선생님께 배정받은 3자리 고유 번호를 입력하면 해당 반의 최신 소식을 확인할 수 있습니다. (예: 101 → 1학년 1반)</p>
      <form id="classroom-form">
        <label for="classroom-code">반 고유 번호</label>
        <div class="form-row">
          <input id="classroom-code" name="classroom-code" inputmode="numeric" placeholder="예: 101" required />
          <button class="submit-btn" type="submit">입장하기</button>
        </div>
        <p id="classroom-error" class="error-text">등록되지 않은 고유 번호입니다. 다시 확인해 주세요.</p>
      </form>
    </section>

    <section id="classroom-news" class="panel classroom-news">
      <div class="news-section-title">
        <h3 id="classroom-news-title">반별 뉴스룸</h3>
        <span id="classroom-news-count" class="pill">총 0건</span>
      </div>
      <div id="class-news-list" class="news-list"></div>
    </section>

    <section id="admin-controls" class="panel admin-controls">
      <h3>학교 기사 관리</h3>
      <form id="news-form">
        <div>
          <label for="news-title">제목</label>
          <input id="news-title" name="title" placeholder="기사 제목을 입력하세요." required />
        </div>
        <div>
          <label for="news-date">날짜</label>
          <input id="news-date" name="date" type="date" required />
        </div>
        <div>
          <label for="news-summary">한 줄 요약</label>
          <textarea id="news-summary" name="summary" placeholder="핵심 내용을 간단히 작성해 주세요." required></textarea>
        </div>
        <div>
          <label for="news-content">본문</label>
          <textarea id="news-content" name="content" placeholder="자세한 기사 내용을 입력해 주세요." required></textarea>
        </div>
        <div>
          <label for="news-link">관련 링크 (선택)</label>
          <input id="news-link" name="link" type="url" placeholder="https://" />
        </div>
        <div class="form-actions">
          <button id="submit-btn" class="submit-btn" type="submit">기사 등록</button>
          <button id="cancel-edit" class="secondary-btn" type="button">취소</button>
        </div>
      </form>
      <div class="share-box">
        <strong>최신 소식 공유 링크</strong>
        <div class="share-actions">
          <input id="share-url" type="text" readonly />
          <button id="copy-share" class="secondary-btn" type="button">링크 복사</button>
        </div>
        <p class="share-help">이 주소를 공유하면 누구나 수정된 내용을 바로 확인할 수 있습니다. 저장 시 자동으로 갱신됩니다.</p>
      </div>
    </section>

    <section id="class-admin-controls" class="panel admin-controls">
      <h3 id="class-admin-heading">반별 기사 관리</h3>
      <form id="class-news-form">
        <div>
          <label for="class-news-title">제목</label>
          <input id="class-news-title" name="title" placeholder="기사 제목을 입력하세요." required />
        </div>
        <div>
          <label for="class-news-date">날짜</label>
          <input id="class-news-date" name="date" type="date" required />
        </div>
        <div>
          <label for="class-news-summary">한 줄 요약</label>
          <textarea id="class-news-summary" name="summary" placeholder="핵심 내용을 간단히 작성해 주세요." required></textarea>
        </div>
        <div>
          <label for="class-news-content">본문</label>
          <textarea id="class-news-content" name="content" placeholder="자세한 기사 내용을 입력해 주세요." required></textarea>
        </div>
        <div>
          <label for="class-news-link">관련 링크 (선택)</label>
          <input id="class-news-link" name="link" type="url" placeholder="https://" />
        </div>
        <div class="form-actions">
          <button id="class-submit-btn" class="submit-btn" type="submit">기사 등록</button>
          <button id="class-cancel-edit" class="secondary-btn" type="button">취소</button>
        </div>
      </form>
      <p class="share-help">반별 기사도 동일한 공유 링크에 함께 저장됩니다.</p>
    </section>
  </main>

  <footer>
    <p>© <span id="year"></span> 동신과학고등학교 뉴스룸. 관리자 승인 하에 운영됩니다.</p>
  </footer>

  <div id="login-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="login-heading">
    <div class="modal-content">
      <h3 id="login-heading">관리자 로그인</h3>
      <form id="login-form">
        <div>
          <label for="admin-id">아이디</label>
          <input id="admin-id" name="admin-id" autocomplete="username" required />
        </div>
        <div>
          <label for="admin-password">비밀번호</label>
          <input id="admin-password" name="admin-password" type="password" autocomplete="current-password" required />
        </div>
        <div id="login-error" class="error-text">아이디 또는 비밀번호가 올바르지 않습니다.</div>
        <div class="modal-actions">
          <button class="submit-btn" type="submit">로그인</button>
          <button id="close-modal" class="modal-close" type="button">닫기</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function () {
      const ADMIN_ID = 'admin';
      const ADMIN_PASSWORD = 'dongsin2024!';
      const STORAGE_KEY = 'dongsin-news-state-v2';
      const SHARE_HASH_PREFIX = 'state=';

      const CLASSROOMS = {
        '101': {
          name: '1학년 1반',
          defaultNews: [
            {
              title: '과학실 안전교육 이수 안내',
              date: '2024-05-08',
              summary: '실험실 안전교육 이수가 필수입니다.',
              content: '5월 둘째 주 과학 시간에 실험실 안전교육이 진행됩니다. 교육을 이수한 학생만 실험에 참여할 수 있으니 지정된 시간표를 확인하고 정시에 입실해 주세요.',
              link: ''
            }
          ]
        },
        '102': {
          name: '1학년 2반',
          defaultNews: [
            {
              title: '융합 프로젝트 킥오프',
              date: '2024-05-09',
              summary: '과학-정보 융합 프로젝트를 시작합니다.',
              content: '팀별 주제를 선정하고 5월 말까지 1차 결과를 제출해야 합니다. 자료조사 일정과 실험 계획서를 이번 주 금요일까지 구글 클래스룸에 업로드하세요.',
              link: ''
            }
          ]
        },
        '103': {
          name: '1학년 3반',
          defaultNews: [
            {
              title: '독서 토론 모임 모집',
              date: '2024-05-03',
              summary: '매주 금요일 점심시간에 토론 모임이 열립니다.',
              content: '첫 번째 도서는 「과학자들」이며, 참여 희망자는 수요일까지 반장에게 알려 주세요. 함께 읽고 싶은 책이 있다면 추천서를 제출해 주세요.',
              link: ''
            }
          ]
        },
        '104': {
          name: '1학년 4반',
          defaultNews: [
            {
              title: '생활기록부 특기사항 작성 안내',
              date: '2024-05-08',
              summary: '생활기록부 특기사항 초안을 준비해주세요.',
              content: '5월 둘째 주 수요일까지 개인별 활동 내용을 정리해 담임 선생님께 제출해 주세요. 작성 예시는 학급 게시판에 게시되어 있으니 참고 바랍니다.',
              link: ''
            }
          ]
        },
        '105': {
          name: '1학년 5반',
          defaultNews: [
            {
              title: '체육대회 응원 연습 일정',
              date: '2024-05-10',
              summary: '체육대회를 위한 응원 연습이 시작됩니다.',
              content: '월·수 방과후 체육관에서 연습하며, 반별 응원도구는 학생회에서 제공합니다. 불참 시 담임 선생님께 사전 연락 바랍니다.',
              link: ''
            }
          ]
        }
      };

      const defaultNews = [
        {
          title: '미래형 과학관 리모델링 완료',
          date: '2024-05-12',
          summary: '스마트 과학관이 새롭게 문을 열었습니다.',
          content: '미래형 실험 장비와 VR 체험관이 도입된 과학관이 정식 개관했습니다. 예약제로 운영되며 각 반 과학 시간에 체험 일정이 안내될 예정입니다.',
          link: ''
        },
        {
          title: '동아리 페스티벌 참가 안내',
          date: '2024-05-07',
          summary: '6월 첫째 주 동아리 페스티벌이 열립니다.',
          content: '체험 부스 신청은 5월 20일까지 학생회 카페에서 가능합니다. 공연 동아리는 행사 전주 리허설에 반드시 참여해 주세요.',
          link: ''
        }
      ];

      const defaultState = createDefaultState();
      let appState = cloneState(defaultState);
      let isAdmin = false;
      let editingIndex = null;
      let classEditingIndex = null;
      let currentClassCode = null;

      const newsList = document.getElementById('news-list');
      const newsCount = document.getElementById('news-count');
      const classroomForm = document.getElementById('classroom-form');
      const classroomCodeInput = document.getElementById('classroom-code');
      const classroomError = document.getElementById('classroom-error');
      const classroomNewsSection = document.getElementById('classroom-news');
      const classroomNewsTitle = document.getElementById('classroom-news-title');
      const classroomNewsCount = document.getElementById('classroom-news-count');
      const classNewsList = document.getElementById('class-news-list');
      const adminControls = document.getElementById('admin-controls');
      const classAdminControls = document.getElementById('class-admin-controls');
      const loginToggle = document.getElementById('login-toggle');
      const loginModal = document.getElementById('login-modal');
      const loginForm = document.getElementById('login-form');
      const loginError = document.getElementById('login-error');
      const loginStatus = document.getElementById('login-status');
      const closeModalBtn = document.getElementById('close-modal');
      const newsForm = document.getElementById('news-form');
      const submitBtn = document.getElementById('submit-btn');
      const cancelEditBtn = document.getElementById('cancel-edit');
      const classNewsForm = document.getElementById('class-news-form');
      const classSubmitBtn = document.getElementById('class-submit-btn');
      const classCancelEditBtn = document.getElementById('class-cancel-edit');
      const classAdminHeading = document.getElementById('class-admin-heading');
      const shareInput = document.getElementById('share-url');
      const copyShareBtn = document.getElementById('copy-share');

      document.getElementById('year').textContent = new Date().getFullYear();

      loadState();
      renderNews();
      updateShareLink();

      loginToggle.addEventListener('click', () => {
        if (isAdmin) {
          if (confirm('로그아웃 하시겠습니까?')) {
            toggleAdminControls(false);
          }
          return;
        }
        loginModal.classList.add('open');
        loginError.classList.remove('visible');
        requestAnimationFrame(() => document.getElementById('admin-id').focus());
      });

      closeModalBtn.addEventListener('click', closeModal);

      loginModal.addEventListener('click', (event) => {
        if (event.target === loginModal) {
          closeModal();
        }
      });

      loginForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const id = event.target['admin-id'].value.trim();
        const password = event.target['admin-password'].value;
        if (id === ADMIN_ID && password === ADMIN_PASSWORD) {
          toggleAdminControls(true);
          loginModal.classList.remove('open');
          loginForm.reset();
          loginError.classList.remove('visible');
        } else {
          loginError.classList.add('visible');
        }
      });

      classroomForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const code = String(classroomCodeInput.value).trim();
        if (CLASSROOMS[code]) {
          enterClassroom(code);
          classroomCodeInput.value = '';
          classroomError.classList.remove('visible');
          setTimeout(() => {
            classroomNewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 60);
        } else {
          classroomError.classList.add('visible');
        }
      });

      classroomCodeInput.addEventListener('input', () => classroomError.classList.remove('visible'));

      newsForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const data = serializeForm(event.target);
        if (editingIndex !== null) {
          appState.general.splice(editingIndex, 1, data);
          editingIndex = null;
          submitBtn.textContent = '기사 등록';
        } else {
          appState.general.push(data);
        }
        newsForm.reset();
        persistState();
        renderNews();
        alert('소식이 저장되었습니다.');
      });

      cancelEditBtn.addEventListener('click', () => {
        editingIndex = null;
        newsForm.reset();
        submitBtn.textContent = '기사 등록';
      });

      classNewsForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!currentClassCode) {
          alert('먼저 반 고유 번호를 입력해 주세요.');
          return;
        }
        const data = serializeForm(event.target);
        const list = appState.classes[currentClassCode];
        if (classEditingIndex !== null) {
          list.splice(classEditingIndex, 1, data);
          classEditingIndex = null;
          classSubmitBtn.textContent = '기사 등록';
        } else {
          list.push(data);
        }
        classNewsForm.reset();
        persistState();
        renderClassNews();
        alert('반별 소식이 저장되었습니다.');
      });

      classCancelEditBtn.addEventListener('click', () => {
        classEditingIndex = null;
        classNewsForm.reset();
        classSubmitBtn.textContent = '기사 등록';
      });

      newsList.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;
        const index = Number(button.dataset.index);
        if (button.dataset.action === 'delete') {
          if (confirm('이 기사를 삭제하시겠습니까?')) {
            appState.general.splice(index, 1);
            persistState();
            renderNews();
          }
        } else if (button.dataset.action === 'edit') {
          const item = appState.general[index];
          fillForm(newsForm, item);
          editingIndex = index;
          submitBtn.textContent = '기사 수정';
          window.scrollTo({ top: adminControls.offsetTop - 80, behavior: 'smooth' });
        }
      });

      classNewsList.addEventListener('click', (event) => {
        const button = event.target.closest('button');
        if (!button) return;
        const index = Number(button.dataset.index);
        const list = currentClassCode ? appState.classes[currentClassCode] : [];
        if (button.dataset.action === 'delete') {
          if (confirm('이 기사를 삭제하시겠습니까?')) {
            list.splice(index, 1);
            persistState();
            renderClassNews();
          }
        } else if (button.dataset.action === 'edit') {
          const item = list[index];
          fillForm(classNewsForm, item);
          classEditingIndex = index;
          classSubmitBtn.textContent = '기사 수정';
          window.scrollTo({ top: classAdminControls.offsetTop - 80, behavior: 'smooth' });
        }
      });

      copyShareBtn.addEventListener('click', () => {
        if (!shareInput.value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(shareInput.value).then(
            () => alert('공유 링크가 복사되었습니다.'),
            () => fallbackCopy(shareInput)
          );
        } else {
          fallbackCopy(shareInput);
        }
      });

      window.addEventListener('hashchange', () => {
        const decoded = decodeStateFromHash();
        if (!decoded) return;
        appState = normalizeState(decoded);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        renderNews();
        if (currentClassCode) {
          renderClassNews();
        }
        updateShareLink(false);
      });

      function loadState() {
        const fromHash = decodeStateFromHash();
        if (fromHash) {
          appState = normalizeState(fromHash);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
          return;
        }
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          try {
            appState = normalizeState(JSON.parse(stored));
            return;
          } catch (error) {
            console.warn('저장된 데이터를 불러오는 중 오류 발생:', error);
          }
        }
        appState = cloneState(defaultState);
        persistState();
      }

      function persistState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        updateShareLink();
      }

      function updateShareLink(updateHash = true) {
        if (!shareInput) return;
        try {
          const json = JSON.stringify(appState);
          const encoded = encodeBase64(json);
          const base = window.location.href.split('#')[0];
          const hash = `${SHARE_HASH_PREFIX}${encoded}`;
          const url = `${base}#${hash}`;
          shareInput.value = url;
          if (updateHash) {
            history.replaceState(null, '', `#${hash}`);
          }
        } catch (error) {
          console.warn('공유 링크 생성에 실패했습니다:', error);
        }
      }

      function enterClassroom(code) {
        currentClassCode = code;
        classAdminHeading.textContent = `${CLASSROOMS[code].name} 기사 관리`;
        classroomNewsTitle.textContent = `${CLASSROOMS[code].name} 뉴스룸`;
        renderClassNews();
        updateClassAdminVisibility();
      }

      function renderNews() {
        newsList.innerHTML = '';
        if (!appState.general.length) {
          newsList.innerHTML = '<p class="placeholder">아직 등록된 소식이 없습니다. 관리자 로그인을 통해 첫 소식을 등록해 주세요.</p>';
          newsCount.textContent = '등록된 소식이 없습니다';
          return;
        }
        const sorted = [...appState.general].sort((a, b) => new Date(b.date) - new Date(a.date));
        sorted.forEach((item) => {
          const originalIndex = appState.general.indexOf(item);
          const article = document.createElement('article');
          article.className = 'news-card';
          article.innerHTML = `
            <span class="news-date">${formatDate(item.date)}</span>
            <h4 class="news-title">${escapeHtml(item.title)}</h4>
            <p class="news-summary"><strong>${escapeHtml(item.summary)}</strong></p>
            <p class="news-content">${escapeHtml(item.content)}</p>
            ${item.link ? `<a class="news-link" href="${escapeAttribute(item.link)}" target="_blank" rel="noopener">자세히 보기 →</a>` : ''}
          `;
          if (isAdmin) {
            const actions = document.createElement('div');
            actions.className = 'form-actions';
            actions.innerHTML = `
              <button class="secondary-btn" type="button" data-action="edit" data-index="${originalIndex}">수정</button>
              <button class="submit-btn" type="button" data-action="delete" data-index="${originalIndex}">삭제</button>
            `;
            article.appendChild(actions);
          }
          newsList.appendChild(article);
        });
        newsCount.textContent = `총 ${appState.general.length}건의 업데이트`;
      }

      function renderClassNews() {
        if (!currentClassCode) {
          classroomNewsSection.classList.remove('visible');
          return;
        }
        classroomNewsSection.classList.add('visible');
        const list = appState.classes[currentClassCode];
        classNewsList.innerHTML = '';
        if (!list.length) {
          classNewsList.innerHTML = '<p class="placeholder">아직 등록된 소식이 없습니다. 관리자 로그인을 통해 첫 소식을 등록해 주세요.</p>';
          classroomNewsCount.textContent = '총 0건';
          return;
        }
        const sorted = [...list].sort((a, b) => new Date(b.date) - new Date(a.date));
        sorted.forEach((item) => {
          const originalIndex = list.indexOf(item);
          const article = document.createElement('article');
          article.className = 'news-card';
          article.innerHTML = `
            <span class="news-date">${formatDate(item.date)}</span>
            <h4 class="news-title">${escapeHtml(item.title)}</h4>
            <p class="news-summary"><strong>${escapeHtml(item.summary)}</strong></p>
            <p class="news-content">${escapeHtml(item.content)}</p>
            ${item.link ? `<a class="news-link" href="${escapeAttribute(item.link)}" target="_blank" rel="noopener">자세히 보기 →</a>` : ''}
          `;
          if (isAdmin) {
            const actions = document.createElement('div');
            actions.className = 'form-actions';
            actions.innerHTML = `
              <button class="secondary-btn" type="button" data-action="edit" data-index="${originalIndex}">수정</button>
              <button class="submit-btn" type="button" data-action="delete" data-index="${originalIndex}">삭제</button>
            `;
            article.appendChild(actions);
          }
          classNewsList.appendChild(article);
        });
        classroomNewsCount.textContent = `총 ${list.length}건`;
      }

      function toggleAdminControls(state) {
        isAdmin = state;
        if (isAdmin) {
          adminControls.classList.add('visible');
          loginToggle.textContent = '로그아웃';
          loginStatus.innerHTML = '<span class="badge">관리자</span><span>편집 모드</span>';
        } else {
          adminControls.classList.remove('visible');
          classAdminControls.classList.remove('visible');
          loginToggle.textContent = '관리자 로그인';
          loginStatus.innerHTML = '<span class="badge">게스트</span><span>읽기 전용 모드</span>';
          editingIndex = null;
          classEditingIndex = null;
          newsForm.reset();
          classNewsForm.reset();
          submitBtn.textContent = '기사 등록';
          classSubmitBtn.textContent = '기사 등록';
        }
        updateClassAdminVisibility();
        renderNews();
        if (currentClassCode) {
          renderClassNews();
        }
      }

      function updateClassAdminVisibility() {
        if (isAdmin && currentClassCode) {
          classAdminControls.classList.add('visible');
        } else {
          classAdminControls.classList.remove('visible');
        }
      }

      function closeModal() {
        loginModal.classList.remove('open');
        loginForm.reset();
      }

      function serializeForm(form) {
        const formData = new FormData(form);
        return {
          title: (formData.get('title') || '').toString().trim(),
          date: (formData.get('date') || '').toString(),
          summary: (formData.get('summary') || '').toString().trim(),
          content: (formData.get('content') || '').toString().trim(),
          link: (formData.get('link') || '').toString().trim()
        };
      }

      function fillForm(form, data) {
        form.querySelector('[name="title"]').value = data.title || '';
        form.querySelector('[name="date"]').value = data.date || '';
        form.querySelector('[name="summary"]').value = data.summary || '';
        form.querySelector('[name="content"]').value = data.content || '';
        form.querySelector('[name="link"]').value = data.link || '';
      }

      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString + 'T09:00:00');
        if (Number.isNaN(date.getTime())) return dateString;
        return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
      }

      function updateClassAdminVisibilityAfterHash() {
        if (currentClassCode && !CLASSROOMS[currentClassCode]) {
          currentClassCode = null;
        }
        updateClassAdminVisibility();
      }

      function fallbackCopy(input) {
        input.select();
        document.execCommand('copy');
        input.blur();
        alert('공유 링크가 복사되었습니다.');
      }

      function decodeStateFromHash() {
        if (!location.hash) return null;
        const raw = location.hash.slice(1);
        const payload = raw.startsWith(SHARE_HASH_PREFIX) ? raw.slice(SHARE_HASH_PREFIX.length) : raw;
        if (!payload) return null;
        try {
          const json = decodeBase64(payload);
          return JSON.parse(json);
        } catch (error) {
          console.warn('URL에서 상태를 불러올 수 없습니다:', error);
          return null;
        }
      }

      function normalizeState(state) {
        const normalized = {
          general: Array.isArray(state?.general) ? state.general.map(sanitizeNews) : cloneState(defaultState.general),
          classes: {}
        };
        Object.keys(CLASSROOMS).forEach((code) => {
          const items = state?.classes?.[code];
          normalized.classes[code] = Array.isArray(items) ? items.map(sanitizeNews) : cloneState(defaultState.classes[code]);
        });
        return normalized;
      }

      function sanitizeNews(item) {
        return {
          title: (item?.title || '').toString().trim(),
          date: (item?.date || '').toString(),
          summary: (item?.summary || '').toString().trim(),
          content: (item?.content || '').toString().trim(),
          link: (item?.link || '').toString().trim()
        };
      }

      function createDefaultState() {
        return {
          general: cloneState(defaultNews),
          classes: Object.fromEntries(
            Object.entries(CLASSROOMS).map(([code, info]) => [code, cloneState(info.defaultNews || [])])
          )
        };
      }

      function cloneState(value) {
        return JSON.parse(JSON.stringify(value));
      }

      function encodeBase64(text) {
        const bytes = new TextEncoder().encode(text);
        let binary = '';
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary)
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/g, '');
      }

      function decodeBase64(encoded) {
        let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/').replace(/\s/g, '+');
        const padding = base64.length % 4;
        if (padding) {
          base64 += '='.repeat(4 - padding);
        }
        const binary = atob(base64);
        const bytes = Uint8Array.from(binary, (char) => char.charCodeAt(0));
        return new TextDecoder().decode(bytes);
      }

      function escapeHtml(value) {
        return (value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function escapeAttribute(value) {
        return escapeHtml(value).replace(/\(/g, '&#40;').replace(/\)/g, '&#41;');
      }

      updateClassAdminVisibilityAfterHash();
    })();
  </script>
</body>
</html>
