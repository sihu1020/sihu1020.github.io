<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>동신과학고 12기 뉴스룸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --bg: #020617;
        --bg-soft: rgba(15, 23, 42, 0.7);
        --surface: rgba(30, 41, 59, 0.78);
        --surface-solid: #0f172a;
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --accent-soft: rgba(56, 189, 248, 0.16);
        --text: #f8fafc;
        --muted: #94a3b8;
        --border: rgba(148, 163, 184, 0.24);
        --shadow: 0 32px 55px rgba(8, 47, 73, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        font-family: "Pretendard", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.3), transparent 42%),
          radial-gradient(circle at bottom left, rgba(99, 102, 241, 0.28), transparent 50%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.75rem 1.75rem 4rem;
        display: grid;
        gap: 2rem;
      }

      header {
        display: grid;
        gap: 1.75rem;
        padding: 2.2rem;
        border-radius: 32px;
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.22), rgba(14, 165, 233, 0.12));
        border: 1px solid rgba(125, 211, 252, 0.25);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
      }

      header::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 12% 25%, rgba(14, 165, 233, 0.42), transparent 55%);
        opacity: 0.65;
        pointer-events: none;
      }

      .branding {
        display: flex;
        gap: 1.25rem;
        align-items: center;
        position: relative;
        z-index: 1;
      }

      .branding img {
        width: clamp(82px, 18vw, 108px);
        aspect-ratio: 1;
        object-fit: contain;
        border-radius: 50%;
        border: 2px solid rgba(148, 163, 184, 0.25);
        padding: 0.65rem;
        background: rgba(15, 23, 42, 0.35);
        backdrop-filter: blur(6px);
      }

      .branding h1 {
        margin: 0;
        font-size: clamp(2.1rem, 4vw, 2.8rem);
        letter-spacing: 0.02em;
      }

      .tagline {
        margin: 0;
        color: rgba(226, 232, 240, 0.85);
        font-weight: 500;
      }

      .grid-two {
        display: grid;
        gap: 1.6rem;
      }

      @media (min-width: 900px) {
        .grid-two {
          grid-template-columns: 1.35fr 1fr;
        }
      }

      section.card {
        background: var(--surface);
        border-radius: 26px;
        border: 1px solid var(--border);
        padding: 2rem;
        position: relative;
        backdrop-filter: blur(12px);
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.45);
      }

      section.card h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.45rem;
        font-weight: 600;
      }

      .news-list {
        display: grid;
        gap: 1.1rem;
      }

      .news-card {
        padding: 1.3rem 1.4rem;
        border-radius: 20px;
        background: linear-gradient(130deg, rgba(148, 163, 184, 0.08), rgba(148, 163, 184, 0.02));
        border: 1px solid rgba(148, 163, 184, 0.18);
        transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        position: relative;
      }

      .news-card:hover {
        transform: translateY(-4px);
        border-color: rgba(56, 189, 248, 0.35);
        box-shadow: 0 18px 38px rgba(8, 47, 73, 0.35);
      }

      .news-card h3 {
        margin: 0;
        font-size: 1.18rem;
        font-weight: 600;
      }

      .news-card .meta {
        margin-top: 0.35rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .news-card p {
        margin: 0.9rem 0 0;
        line-height: 1.6;
      }

      .news-actions {
        margin-top: 0.9rem;
        display: flex;
        gap: 0.65rem;
      }

      .btn {
        font: inherit;
        border: none;
        border-radius: 14px;
        padding: 0.55rem 1rem;
        background: rgba(56, 189, 248, 0.14);
        color: var(--text);
        cursor: pointer;
        transition: background 0.25s ease, transform 0.25s ease;
      }

      .btn:hover {
        background: rgba(14, 165, 233, 0.32);
        transform: translateY(-1px);
      }

      .btn-outline {
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.35);
      }

      .btn-outline:hover {
        border-color: rgba(56, 189, 248, 0.6);
      }

      form {
        display: grid;
        gap: 0.9rem;
      }

      label {
        display: grid;
        gap: 0.45rem;
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.78);
      }

      input,
      textarea,
      select {
        font: inherit;
        color: var(--text);
        background: rgba(15, 23, 42, 0.75);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 0.65rem 0.9rem;
        transition: border 0.25s ease, box-shadow 0.25s ease;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: rgba(56, 189, 248, 0.5);
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      .form-row {
        display: grid;
        gap: 0.75rem;
      }

      @media (min-width: 720px) {
        .form-row.two {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .status-message {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 14px;
        background: rgba(56, 189, 248, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.32);
        color: rgba(226, 232, 240, 0.88);
        font-size: 0.95rem;
      }

      .helper-text {
        display: block;
        font-size: 0.8rem;
        color: rgba(148, 163, 184, 0.78);
      }

      .admin-actions {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        justify-content: flex-end;
      }

      .admin-actions .btn {
        flex: 1;
      }

      .status-card {
        padding: 1rem 1.25rem;
        border-radius: 16px;
        background: rgba(56, 189, 248, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.28);
        color: rgba(226, 232, 240, 0.85);
        font-size: 0.92rem;
        line-height: 1.5;
      }

      @media (max-width: 719px) {
        .admin-actions {
          flex-direction: column;
          align-items: stretch;
        }
      }

      .hidden {
        display: none !important;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        font-size: 0.8rem;
        background: rgba(56, 189, 248, 0.15);
        color: rgba(226, 232, 240, 0.85);
      }

      .class-news-header {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .empty-state {
        padding: 1.3rem 1.1rem;
        border-radius: 18px;
        border: 1px dashed rgba(148, 163, 184, 0.35);
        color: rgba(148, 163, 184, 0.85);
        text-align: center;
      }

      footer {
        text-align: center;
        color: rgba(148, 163, 184, 0.7);
        font-size: 0.85rem;
        margin-bottom: 2.5rem;
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div class="branding">
          <div>
            <h1>동신과학고 12기 뉴스</h1>
            <p class="tagline">우리 모두의 하루를 연결하는 공식 소식 허브</p>
          </div>
        </div>
      </header>

      <div class="grid-two">
        <section class="card" id="general-news-section">
          <h2>학년 전체 공지</h2>
          <div class="news-list" id="general-news-list"></div>
        </section>

        <section class="card" id="class-news-section">
          <div class="class-news-header">
            <h2>우리 반 소식</h2>
            <span class="pill" id="current-class-pill">반을 선택해주세요</span>
          </div>
          <form id="student-id-form" autocomplete="off">
            <label>
              학번 입력 (예: 1207)
              <div class="form-row two">
                <input type="text" id="student-id" placeholder="학번" maxlength="4" required />
                <button class="btn" type="submit">확인</button>
              </div>
            </label>
            <p class="status-message hidden" id="student-id-message"></p>
          </form>
          <div class="news-list" id="class-news-list"></div>
        </section>
      </div>

      <section class="card" id="admin-panel">
        <div class="class-news-header">
          <h2>관리자 콘솔</h2>
          <span class="pill" id="admin-status">비로그인 상태</span>
        </div>
        <form id="admin-login-form" autocomplete="off">
          <div class="form-row two">
            <label>
              관리자 비밀번호
              <input type="password" id="admin-password" placeholder="비밀번호를 입력하세요" />
            </label>
            <label>
              <span style="visibility:hidden">submit</span>
              <button class="btn" type="submit">로그인</button>
            </label>
          </div>
          <p class="status-message hidden" id="admin-login-message"></p>
        </form>

        <div id="admin-tools" class="hidden">
          <div class="status-card">
            GitHub 저장소에 뉴스를 저장하여 모든 사용자가 새로고침만으로 최신 공지와 반별 소식을 확인할 수 있습니다.
            토큰은 이 브라우저 세션에만 사용되며 저장되지 않습니다.
          </div>

          <div class="form-row two">
            <label>
              GitHub Personal Access Token
              <input
                type="password"
                id="admin-token"
                placeholder="repo 권한이 포함된 토큰을 입력하세요"
                autocomplete="new-password"
              />
              <span class="helper-text">토큰이 없으면 저장이 진행되지 않습니다.</span>
            </label>
            <div class="admin-actions">
              <button class="btn-outline btn" type="button" id="sync-refresh-button">최신 데이터 불러오기</button>
            </div>
          </div>

          <p class="status-message hidden" id="sync-status-message"></p>

          <div class="form-row">
            <h3 style="margin: 0 0 0.5rem">학년 전체 공지 등록</h3>
            <form id="general-news-form" autocomplete="off">
              <label>
                제목
                <input type="text" id="general-title" placeholder="제목을 입력하세요" required />
              </label>
              <label>
                내용
                <textarea id="general-content" placeholder="공지 내용을 작성하세요" required></textarea>
              </label>
              <button class="btn" type="submit">공지 등록</button>
            </form>
          </div>

          <div class="form-row" style="margin-top: 2rem">
            <h3 style="margin: 0 0 0.5rem">반별 소식 등록</h3>
            <form id="class-news-form" autocomplete="off">
              <div class="form-row two">
                <label>
                  학년
                  <select id="class-grade" required>
                    <option value="">선택</option>
                    <option value="1">1학년</option>
                    <option value="2">2학년</option>
                    <option value="3">3학년</option>
                  </select>
                </label>
                <label>
                  반
                  <select id="class-number" required>
                    <option value="">선택</option>
                    <option value="1">1반</option>
                    <option value="2">2반</option>
                    <option value="3">3반</option>
                    <option value="4">4반</option>
                    <option value="5">5반</option>
                  </select>
                </label>
              </div>
              <label>
                제목
                <input type="text" id="class-title" placeholder="제목을 입력하세요" required />
              </label>
              <label>
                내용
                <textarea id="class-content" placeholder="반 소식을 작성하세요" required></textarea>
              </label>
              <button class="btn" type="submit">소식 등록</button>
            </form>
          </div>
        </div>
      </section>

      <footer>© 2024 동신과학고 12기 뉴스룸 · 실시간으로 공유되는 우리 반 이야기</footer>
    </main>

    <script>
      const dom = {
        generalList: document.getElementById("general-news-list"),
        classList: document.getElementById("class-news-list"),
        classPill: document.getElementById("current-class-pill"),
        classForm: document.getElementById("student-id-form"),
        studentIdInput: document.getElementById("student-id"),
        studentIdMessage: document.getElementById("student-id-message"),
        adminStatus: document.getElementById("admin-status"),
        adminLoginForm: document.getElementById("admin-login-form"),
        adminPassword: document.getElementById("admin-password"),
        adminLoginMessage: document.getElementById("admin-login-message"),
        adminTools: document.getElementById("admin-tools"),
        generalForm: document.getElementById("general-news-form"),
        generalTitle: document.getElementById("general-title"),
        generalContent: document.getElementById("general-content"),
        classNewsForm: document.getElementById("class-news-form"),
        classGrade: document.getElementById("class-grade"),
        classNumber: document.getElementById("class-number"),
        classTitle: document.getElementById("class-title"),
        classContent: document.getElementById("class-content"),
        adminToken: document.getElementById("admin-token"),
        syncStatusMessage: document.getElementById("sync-status-message"),
        syncRefreshButton: document.getElementById("sync-refresh-button")
      };

      const STORAGE_KEY = "dongsin-news-data";
      const ADMIN_SESSION_KEY = "dongsin-news-admin";
      const ADMIN_PASSWORD = "0928";
      const GITHUB_CONFIG = {
        owner: "sihu1020",
        repo: "sihu1020.github.io",
        path: "data/news.json",
        branch: "main"
      };

      const STATUS_STYLES = {
        info: {
          background: "rgba(56, 189, 248, 0.12)",
          border: "rgba(56, 189, 248, 0.32)"
        },
        success: {
          background: "rgba(34, 197, 94, 0.16)",
          border: "rgba(74, 222, 128, 0.38)"
        },
        error: {
          background: "rgba(248, 113, 113, 0.18)",
          border: "rgba(248, 113, 113, 0.45)"
        }
      };

      const textEncoder = new TextEncoder();
      const textDecoder = new TextDecoder();

      let statusTimeout = null;
      let remoteSha = null;
      let isSaving = false;
      let isFetching = false;
      let hasInitialSync = false;

      function uid() {
        if (window.crypto?.randomUUID) {
          return crypto.randomUUID();
        }
        return `id-${Date.now()}-${Math.random().toString(16).slice(2)}`;
      }

      const clone = (value) => {
        try {
          return structuredClone(value);
        } catch (error) {
          return JSON.parse(JSON.stringify(value));
        }
      };

      const defaultData = {
        general: [
          {
            id: uid(),
            title: "신학기 전교생 오리엔테이션 안내",
            content:
              "3월 5일(화) 오전 9시, 본교 대강당에서 12기 전교생이 함께하는 오리엔테이션이 진행됩니다. 교복 착용과 필기도구 준비를 잊지 말아주세요!",
            createdAt: new Date().toISOString()
          },
          {
            id: uid(),
            title: "과학탐구 진로 콘서트 신청",
            content:
              "4월 둘째 주에 열리는 과학탐구 진로 콘서트의 참가 신청을 3월 25일까지 받고 있습니다. 참가 희망자는 포스터의 QR코드로 신청해주세요.",
            createdAt: new Date(Date.now() - 86400000 * 2).toISOString()
          }
        ],
        classes: {
          "1-1": [
            {
              id: uid(),
              title: "1반 과학실 대청소",
              content: "이번 주 금요일 7교시 종료 후 과학실 대청소가 있습니다. 청소도구는 3조가 준비합니다.",
              createdAt: new Date(Date.now() - 86400000).toISOString()
            }
          ],
          "1-2": [
            {
              id: uid(),
              title: "2반 소프트웨어 스터디",
              content: "매주 수요일 방과후 4층 프로젝트실에서 파이썬 스터디를 진행합니다. 지각 없이 참여해주세요!",
              createdAt: new Date(Date.now() - 86400000 * 3).toISOString()
            }
          ],
          "1-3": [],
          "1-4": [],
          "1-5": [],
          "2-1": [],
          "2-2": [],
          "2-3": [],
          "2-4": [],
          "2-5": [],
          "3-1": [],
          "3-2": [],
          "3-3": [],
          "3-4": [],
          "3-5": []
        }
      };

      function sanitizeNewsItem(item) {
        if (!item || typeof item !== "object") {
          return null;
        }
        const normalized = {
          id: typeof item.id === "string" && item.id ? item.id : uid(),
          title: typeof item.title === "string" ? item.title : String(item.title ?? ""),
          content: typeof item.content === "string" ? item.content : String(item.content ?? ""),
          createdAt:
            typeof item.createdAt === "string" && item.createdAt
              ? item.createdAt
              : new Date().toISOString()
        };
        if (!normalized.title.trim() || !normalized.content.trim()) {
          return null;
        }
        return normalized;
      }

      function sanitizeData(raw) {
        if (!raw || typeof raw !== "object") {
          return clone(defaultData);
        }

        const sanitized = {
          general: Array.isArray(raw.general)
            ? raw.general.map(sanitizeNewsItem).filter(Boolean)
            : [],
          classes: {}
        };

        const classes = raw.classes && typeof raw.classes === "object" ? raw.classes : {};
        const classKeys = new Set([...Object.keys(defaultData.classes), ...Object.keys(classes)]);

        classKeys.forEach((key) => {
          const list = Array.isArray(classes[key]) ? classes[key] : [];
          sanitized.classes[key] = list.map(sanitizeNewsItem).filter(Boolean);
        });

        return sanitized;
      }

      function loadFromCache() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return clone(defaultData);
          const parsed = JSON.parse(raw);
          return sanitizeData(parsed);
        } catch (error) {
          console.error("캐시 불러오기 실패", error);
          return clone(defaultData);
        }
      }

      function updateCache(snapshot) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot));
        } catch (error) {
          console.warn("캐시 저장 실패", error);
        }
      }

      function setSyncStatus(message, type = "info", persistent = false) {
        if (!dom.syncStatusMessage) return;
        const styles = STATUS_STYLES[type] ?? STATUS_STYLES.info;
        dom.syncStatusMessage.textContent = message;
        dom.syncStatusMessage.style.background = styles.background;
        dom.syncStatusMessage.style.borderColor = styles.border;
        dom.syncStatusMessage.classList.remove("hidden");
        if (statusTimeout) {
          clearTimeout(statusTimeout);
        }
        if (!persistent) {
          statusTimeout = setTimeout(() => {
            dom.syncStatusMessage.classList.add("hidden");
          }, 5000);
        }
      }

      function encodeContent(payload) {
        const json = JSON.stringify(payload, null, 2);
        const bytes = textEncoder.encode(json);
        let binary = "";
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary);
      }

      function decodeContent(content) {
        const cleaned = (content ?? "").replace(/\n/g, "");
        const binary = atob(cleaned);
        const bytes = Uint8Array.from(binary, (char) => char.charCodeAt(0));
        return textDecoder.decode(bytes);
      }

      function getGitHubContentUrl() {
        return `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}?ref=${GITHUB_CONFIG.branch}`;
      }

      async function syncFromRemote(options = {}) {
        const { showMessage = false } = options;
        if (isSaving) {
          if (showMessage) {
            setSyncStatus("변경 사항을 저장 중입니다. 잠시 후 다시 시도하세요.");
          }
          return false;
        }
        if (isFetching) {
          return false;
        }
        isFetching = true;
        if (showMessage) {
          setSyncStatus("최신 데이터를 불러오는 중입니다...", "info", true);
        }
        try {
          const response = await fetch(getGitHubContentUrl(), {
            headers: {
              Accept: "application/vnd.github+json"
            },
            cache: "no-store"
          });
          if (response.status === 404) {
            remoteSha = null;
            hasInitialSync = true;
            updateCache(data);
            renderGeneralNews();
            renderClassNews();
            if (showMessage) {
              setSyncStatus("새 데이터 파일을 생성할 준비가 되었습니다.", "success");
            }
            return true;
          }
          if (!response.ok) {
            throw new Error(`원격 데이터를 불러오지 못했습니다: ${response.status}`);
          }
          const payload = await response.json();
          const decoded = decodeContent(payload.content ?? "");
          const parsed = JSON.parse(decoded);
          data = sanitizeData(parsed);
          remoteSha = payload.sha;
          updateCache(data);
          renderGeneralNews();
          renderClassNews();
          hasInitialSync = true;
          if (showMessage) {
            setSyncStatus("최신 데이터로 동기화되었습니다.", "success");
          }
          return true;
        } catch (error) {
          console.error("데이터 동기화 실패", error);
          if (showMessage) {
            setSyncStatus("데이터를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.", "error", true);
          }
          return false;
        } finally {
          isFetching = false;
        }
      }

      async function saveData(actionDescription = "데이터 업데이트") {
        if (!isAdmin) {
          return false;
        }
        if (!hasInitialSync) {
          const synced = await syncFromRemote({ showMessage: true });
          if (!synced) {
            return false;
          }
        }
        const token = dom.adminToken?.value.trim();
        if (!token) {
          setSyncStatus("GitHub 토큰을 입력해주세요.", "error", true);
          return false;
        }
        if (isSaving) {
          setSyncStatus("이미 저장 작업이 진행 중입니다.");
          return false;
        }
        isSaving = true;
        setSyncStatus("변경 사항을 저장하는 중입니다...", "info", true);
        try {
          const response = await fetch(getGitHubContentUrl(), {
            method: "PUT",
            headers: {
              Accept: "application/vnd.github+json",
              Authorization: `token ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              message: `[Newsroom] ${actionDescription}`,
              content: encodeContent(data),
              sha: remoteSha ?? undefined,
              branch: GITHUB_CONFIG.branch
            })
          });
          if (!response.ok) {
            throw new Error(`저장 실패: ${response.status}`);
          }
          const payload = await response.json();
          remoteSha = payload.content?.sha ?? remoteSha;
          updateCache(data);
          hasInitialSync = true;
          setSyncStatus("변경 사항이 저장되었습니다.", "success");
          return true;
        } catch (error) {
          console.error("데이터 저장 실패", error);
          setSyncStatus("저장 중 오류가 발생했습니다. 토큰과 저장소 권한을 확인해주세요.", "error", true);
          return false;
        } finally {
          isSaving = false;
        }
      }

      function deepCloneData(snapshot) {
        return clone(snapshot);
      }

      async function applyChange(mutator, actionDescription, onSuccess) {
        const previous = deepCloneData(data);
        mutator();
        renderGeneralNews();
        renderClassNews();
        const saved = await saveData(actionDescription);
        if (saved) {
          if (typeof onSuccess === "function") {
            onSuccess();
          }
        } else {
          data = previous;
          renderGeneralNews();
          renderClassNews();
        }
      }

      let data = loadFromCache();
      let currentClassKey = null;
      let isAdmin = sessionStorage.getItem(ADMIN_SESSION_KEY) === "true";

      function formatDate(dateString) {
        try {
          return new Date(dateString).toLocaleDateString("ko-KR", {
            month: "short",
            day: "numeric",
            weekday: "short"
          });
        } catch (error) {
          return "최근";
        }
      }

      function renderGeneralNews() {
        dom.generalList.innerHTML = "";
        if (!data.general.length) {
          dom.generalList.innerHTML = '<div class="empty-state">아직 등록된 학년 공지가 없습니다.</div>';
          return;
        }

        data.general
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .forEach((item) => {
            const article = document.createElement("article");
            article.className = "news-card";
            article.dataset.id = item.id;
            article.innerHTML = `
              <h3>${item.title}</h3>
              <div class="meta">${formatDate(item.createdAt)} · 학년 공지</div>
              <p>${item.content.replace(/\n/g, "<br>")}</p>
              ${
                isAdmin
                  ? '<div class="news-actions"><button class="btn-outline btn" data-action="edit-general">수정</button><button class="btn-outline btn" data-action="delete-general">삭제</button></div>'
                  : ""
              }
            `;
            dom.generalList.appendChild(article);
          });
      }

      function ensureClassKey(key) {
        if (!data.classes[key]) {
          data.classes[key] = [];
        }
      }

      function renderClassNews() {
        dom.classList.innerHTML = "";
        if (!currentClassKey) {
          dom.classList.innerHTML = '<div class="empty-state">학번을 입력하면 우리 반 소식을 확인할 수 있습니다.</div>';
          return;
        }
        ensureClassKey(currentClassKey);
        const items = data.classes[currentClassKey];
        if (!items.length) {
          dom.classList.innerHTML = '<div class="empty-state">아직 우리 반 소식이 없습니다. 첫 소식을 기다려보세요!</div>';
          return;
        }

        items
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .forEach((item) => {
            const article = document.createElement("article");
            article.className = "news-card";
            article.dataset.id = item.id;
            article.innerHTML = `
              <h3>${item.title}</h3>
              <div class="meta">${formatDate(item.createdAt)} · ${currentClassKey.replace("-", "학년 ")}반</div>
              <p>${item.content.replace(/\n/g, "<br>")}</p>
              ${
                isAdmin
                  ? '<div class="news-actions"><button class="btn-outline btn" data-action="edit-class">수정</button><button class="btn-outline btn" data-action="delete-class">삭제</button></div>'
                  : ""
              }
            `;
            dom.classList.appendChild(article);
          });
      }

      function setClassPill(text) {
        dom.classPill.textContent = text;
      }

      function updateAdminUI() {
        if (isAdmin) {
          dom.adminStatus.textContent = "관리자 모드 활성화";
          dom.adminStatus.style.background = "rgba(34, 197, 94, 0.28)";
          dom.adminStatus.style.color = "#bbf7d0";
          dom.adminTools.classList.remove("hidden");
          dom.adminLoginForm.classList.add("hidden");
        } else {
          dom.adminStatus.textContent = "비로그인 상태";
          dom.adminStatus.style.background = "rgba(56, 189, 248, 0.15)";
          dom.adminStatus.style.color = "rgba(226, 232, 240, 0.85)";
          dom.adminTools.classList.add("hidden");
          dom.adminLoginForm.classList.remove("hidden");
        }
        renderGeneralNews();
        renderClassNews();
      }

      dom.classForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const id = dom.studentIdInput.value.trim();
        if (!/^\d{4}$/.test(id)) {
          dom.studentIdMessage.textContent = "학번은 4자리 숫자로 입력해주세요.";
          dom.studentIdMessage.classList.remove("hidden");
          return;
        }
        dom.studentIdMessage.classList.add("hidden");
        const grade = id.slice(0, 1);
        const clazz = id.slice(1, 2);
        currentClassKey = `${grade}-${clazz}`;
        ensureClassKey(currentClassKey);
        setClassPill(`${grade}학년 ${clazz}반 소식`);
        renderClassNews();
      });

      dom.adminLoginForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const password = dom.adminPassword.value.trim();
        if (password === ADMIN_PASSWORD) {
          isAdmin = true;
          sessionStorage.setItem(ADMIN_SESSION_KEY, "true");
          dom.adminLoginMessage.textContent = "관리자 인증이 완료되었습니다.";
          dom.adminLoginMessage.classList.remove("hidden");
          dom.adminLoginMessage.style.background = "rgba(34, 197, 94, 0.18)";
          dom.adminLoginMessage.style.borderColor = "rgba(74, 222, 128, 0.35)";
          dom.adminPassword.value = "";
          updateAdminUI();
          setSyncStatus("GitHub 토큰을 입력하면 변경 사항을 저장할 수 있습니다.");
        } else {
          dom.adminLoginMessage.textContent = "비밀번호가 일치하지 않습니다.";
          dom.adminLoginMessage.classList.remove("hidden");
          dom.adminLoginMessage.style.background = "rgba(248, 113, 113, 0.12)";
          dom.adminLoginMessage.style.borderColor = "rgba(248, 113, 113, 0.32)";
          dom.adminPassword.focus();
        }
      });

      dom.generalForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!isAdmin) return;
        const title = dom.generalTitle.value.trim();
        const content = dom.generalContent.value.trim();
        if (!title || !content) return;
        await applyChange(
          () => {
            data.general.push({
              id: uid(),
              title,
              content,
              createdAt: new Date().toISOString()
            });
          },
          `학년 공지 등록 - ${title}`,
          () => {
            dom.generalForm.reset();
          }
        );
      });

      dom.classNewsForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!isAdmin) return;
        const grade = dom.classGrade.value;
        const clazz = dom.classNumber.value;
        const title = dom.classTitle.value.trim();
        const content = dom.classContent.value.trim();
        if (!grade || !clazz || !title || !content) return;
        const key = `${grade}-${clazz}`;
        ensureClassKey(key);
        await applyChange(
          () => {
            data.classes[key].push({
              id: uid(),
              title,
              content,
              createdAt: new Date().toISOString()
            });
          },
          `${grade}학년 ${clazz}반 소식 등록 - ${title}`,
          () => {
            dom.classNewsForm.reset();
            if (currentClassKey === key) {
              renderClassNews();
            }
          }
        );
      });

      dom.generalList.addEventListener("click", async (event) => {
        const action = event.target.dataset.action;
        if (!action || !isAdmin) return;
        const article = event.target.closest(".news-card");
        if (!article) return;
        const id = article.dataset.id;
        const item = data.general.find((news) => news.id === id);
        if (!item) return;

        if (action === "delete-general") {
          if (!confirm("이 공지를 삭제할까요?")) return;
          const title = item.title;
          await applyChange(
            () => {
              data.general = data.general.filter((news) => news.id !== id);
            },
            `학년 공지 삭제 - ${title}`
          );
        }
        if (action === "edit-general") {
          const newTitle = prompt("새 제목을 입력하세요", item.title);
          if (newTitle === null) return;
          const newContent = prompt("새 내용을 입력하세요", item.content);
          if (newContent === null) return;
          const originalTitle = item.title;
          await applyChange(
            () => {
              item.title = newTitle.trim() || item.title;
              item.content = newContent.trim() || item.content;
              item.createdAt = new Date().toISOString();
            },
            `학년 공지 수정 - ${originalTitle}`
          );
        }
      });

      dom.classList.addEventListener("click", async (event) => {
        const action = event.target.dataset.action;
        if (!action || !isAdmin || !currentClassKey) return;
        const article = event.target.closest(".news-card");
        if (!article) return;
        const id = article.dataset.id;
        const items = data.classes[currentClassKey];
        const item = items.find((news) => news.id === id);
        if (!item) return;

        if (action === "delete-class") {
          if (!confirm("이 반 소식을 삭제할까요?")) return;
          const title = item.title;
          await applyChange(
            () => {
              data.classes[currentClassKey] = items.filter((news) => news.id !== id);
            },
            `${currentClassKey.replace("-", "학년 ")}반 소식 삭제 - ${title}`
          );
        }
        if (action === "edit-class") {
          const newTitle = prompt("새 제목을 입력하세요", item.title);
          if (newTitle === null) return;
          const newContent = prompt("새 내용을 입력하세요", item.content);
          if (newContent === null) return;
          const originalTitle = item.title;
          await applyChange(
            () => {
              item.title = newTitle.trim() || item.title;
              item.content = newContent.trim() || item.content;
              item.createdAt = new Date().toISOString();
            },
            `${currentClassKey.replace("-", "학년 ")}반 소식 수정 - ${originalTitle}`
          );
        }
      });

      dom.syncRefreshButton?.addEventListener("click", () => {
        syncFromRemote({ showMessage: true });
      });

      function initialize() {
        renderGeneralNews();
        renderClassNews();
        if (isAdmin) {
          updateAdminUI();
        }
        syncFromRemote();
      }

      initialize();
    </script>
  </body>
</html>
